<div
  class="h-screen w-screen bg-[#0f172a] flex flex-col text-white select-none safe-top safe-bottom overflow-hidden relative touch-none"
  cdkDropListGroup>

  <div cdkDropList
       #ghostList="cdkDropList"
       [cdkDropListSortingDisabled]="true"
       (cdkDropListDropped)="onDropInVoid($event)"
       class="ghost-zone debug-zone absolute inset-0 z-0 w-full h-full">
  </div>

  @if (gameState(); as state) {

    <div [class.blur-md]="!isGameReady() || !state"
         class="flex-col h-full w-full justify-between duration-700 ease-in-out pointer-events-none relative z-10">

      <div class="shrink-0 flex flex-col pt-2 ">
        <header class="shrink-0 p-3 flex justify-between items-center pointer-events-auto">
          <h1 class="text-xl font-black text-orange-500 italic tracking-tighter">Skip-Bo</h1>
          <div class="flex gap-2">
            <span [class.bg-green-500]="state.currentPlayerId === state.me.id"
                  [class.bg-slate-700]="state.currentPlayerId !== state.me.id"
                  class="px-3 py-0.5 rounded-full text-[9px] font-bold uppercase shadow-lg transition-colors animate-in fade-in">
            {{ state.currentPlayerId === state.me.id ? 'YOUR TURN' : 'OPPONENT' }}
            </span>
          </div>
        </header>

        <div class="shrink-0 w-full bg-slate-900/80 border-b border-white/10 pb-4 pt-3 px-2 rounded-b-[1.5rem] shadow-2xl relative overflow-hidden z-10">
          <div class="w-full flex justify-center items-start px-2">
            <div class="flex items-start pl-2 gap-3">
              <div class="flex flex-col items-center pl-2 gap-1">
                <span class="text-[7px] font-black uppercase tracking-widest text-slate-500">Target</span>
                <div class="relative group w-14 h-[84px]">
                  <div class="absolute inset-0 bg-slate-800 rounded-lg translate-y-0.5 translate-x-0.5 border border-white/5"></div>
                  <div class="relative z-10 w-full h-full">
                    @if (state.opponent?.goalPile?.length) {
                      @let topCardOpp = state.opponent!.goalPile[state.opponent!.goalPile.length - 1];
                      <sb-card [card]="topCardOpp" class="w-full h-full shadow-lg rounded-lg"></sb-card>
                    } @else {
                      <div class="w-full h-full bg-slate-900/50 rounded-lg border border-dashed border-slate-700 flex items-center justify-center">
                        <span class="text-slate-600 font-black text-[8px]">GOAL</span>
                      </div>
                    }
                    <div class="absolute -bottom-1.5 -right-1.5 bg-orange-500 text-white text-[9px] font-black w-5 h-5 rounded-full flex items-center justify-center border-2 border-slate-900 shadow-xl z-20">
                      {{ state.opponent?.goalRemaining || 0 }}
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex flex-col items-center gap-1">
                <span class="text-[7px] font-black uppercase tracking-widest text-slate-500">Discards</span>
                <div class="flex gap-1">
                  @for (oppSlot of (state.opponent?.discards || [[], [], [], []]); track $index) {
                    <div class="w-12 h-[108px] bg-slate-800/40  rounded-lg border border-white/5 relative shadow-inner overflow-visible">
                      <div class="relative w-full h-full flex flex-col justify-start">
                        @for (card of (oppSlot || []).slice(-3); track card.id; let i = $index; let total = $count) {
                          <div class="absolute left-0 right-0 w-full"
                               [style.top.px]="(total - 1 - i) * 18"
                               [style.height.px]="72"
                               [style.z-index]="i">
                            <sb-card [card]="card"
                                     [class.brightness-50]="i < (total - 1)"
                                     class="block w-full h-full shadow-sm rounded-lg border border-white/5"></sb-card>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>
            <div class="flex flex-col items-center gap-2">
              <div class="flex items-center gap-1.5 px-2 py-0.5 bg-white/5 rounded-full border border-white/10">
                <div class="w-1.5 h-1.5 rounded-full"
                     [class]="state?.currentPlayerId === state?.opponent?.id ? 'bg-green-500 animate-ping' : 'bg-slate-500'">
                </div>
                <span class="text-[8px] font-bold text-slate-300 uppercase tracking-tighter truncate max-w-[60px]">
                  {{ state.opponent?.name || 'Wait...' }}
                </span>
              </div>
              <div class="w-24 flex justify-center -space-x-3 scale-75 origin-top">
                @for (card of (state.opponent?.hand || []); track $index) {
                  <div [class.animate-bounce-slow]="state.currentPlayerId === state.opponent?.id"
                       class="w-7 h-12 bg-gradient-to-br from-slate-700 to-slate-900 rounded-sm shadow-lg border border-white/20 transform -rotate-12 relative overflow-hidden shrink-0"
                       [style.animation-delay]="$index * 150 + 'ms'">
                    <div class="absolute inset-0 bg-white/5 opacity-50"></div>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <main class="shrink-0 py-6 flex flex-col justify-center items-center relative z-10 pointer-events-none">
        <p class="text-slate-500 text-[8px] uppercase font-black tracking-[0.3em] mb-2">Common Board</p>
        <div class="flex justify-center items-center gap-1 w-full max-w-[340px]">

          <div class="relative w-[72px] aspect-[2/3] flex-shrink-0 group pointer-events-auto">
            <div class="absolute inset-0 bg-slate-800 rounded-lg translate-y-1 translate-x-1 border border-white/5 shadow-lg"></div>
            <div class="absolute inset-0 bg-slate-900 rounded-lg border-2 border-slate-700/50 flex flex-col items-center justify-center overflow-hidden shadow-2xl z-10">
              <div class="absolute top-0 left-0 right-0 bg-slate-800/80 py-1 border-b border-white/5">
                <span class="text-[7px] text-slate-500 font-black uppercase tracking-tighter block text-center italic">Draw Pile</span>
              </div>
              <div class="flex flex-col items-center mt-2">
                <span class="text-slate-400 font-black text-sm italic tracking-tighter leading-none drop-shadow-md">SKIP-BO</span>
                <div class="h-[1px] w-6 bg-orange-500/40 my-1.5 shadow-[0_0_5px_rgba(249,115,22,0.3)]"></div>
              </div>
              <div class="absolute top-1 left-1 w-2 h-2 border-t border-l border-white/10"></div>
              <div class="absolute bottom-1 right-1 w-2 h-2 border-b border-r border-white/10"></div>
              <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/5 to-transparent pointer-events-none"></div>
            </div>
          </div>

          <div class="w-[1px] h-16 bg-gradient-to-b from-transparent via-white/10 to-transparent mx-1"></div>

          <div class="flex justify-center items-center gap-2.5">
            @for (pile of state.commonPiles; let i = $index; track i) {
              <div cdkDropList
                   #dropList="cdkDropList"
                   (cdkDropListDropped)="onDrop($event, i, 'common')"
                   [class.ring-2]="dropList.id === 'cdk-drop-list-' + i"
                   class="common-pile-dropzone relative block bg-slate-800/40 rounded-lg border border-white/5 transition-transform shadow-inner pointer-events-auto
                          w-[58px] h-[86px] p-[1px]"
                   style="contain: size layout;">

                <div class="absolute inset-0 rounded-lg border-2 border-orange-500 opacity-0 transition-opacity duration-150 z-50 pointer-events-none drop-highlight"></div>

                <div class="w-full h-full flex items-center justify-center pointer-events-none">
                  @if (pile?.length) {
                    <sb-card [card]="pile[pile.length - 1]" [visualValueOverride]="pile.length"
                             class="block w-full h-full"></sb-card>
                  } @else {
                    <span class="text-lg font-black text-slate-500 opacity-20 select-none">{{ i + 1 }}</span>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      </main>

      <section class="shrink-0 py-4 pb-24 bg-slate-900/80 backdrop-blur-lg rounded-t-[2rem] border-t border-white/10 shadow-2xl z-30 pointer-events-none">

        <div class="flex justify-center gap-4 px-1 items-start w-full overflow-visible">

          <div class="flex flex-col gap-2 shrink-0">
            <p class="text-orange-500 text-[8px] pb-3 font-black uppercase tracking-widest text-center">Target</p>

            <div cdkDropList
                 #goalList="cdkDropList"
                 [cdkDropListSortingDisabled]="true"
                 [class.ring-4]="selectedSource() === 'goal'"
                 class="single-stack relative w-[58px] h-[86px] p-[1px] ring-orange-500 rounded-xl active:scale-95 cursor-pointer shadow-2xl block pointer-events-auto">

              @if (state.me?.goalPile?.length) {
                @let goalCard = state.me.goalPile[state.me.goalPile.length - 1];

                <div cdkDrag
                     [cdkDragData]="{ source: 'goal', cardId: goalCard.id }"
                     [cdkDragDisabled]="!canDragPredicate()"
                     class="relative w-full h-full rounded-xl z-20 target-card">

                  <sb-card [card]="goalCard" class="block w-full h-full rounded-xl"></sb-card>

                  <ng-template cdkDragPreview [matchSize]="true">
                    <div class="w-full h-full shadow-2xl rounded-xl">
                      <sb-card [card]="goalCard" class="block w-full h-full rounded-xl"></sb-card>
                    </div>
                  </ng-template>

                  <div *cdkDragPlaceholder class="w-full h-full opacity-0"></div>
                </div>

                <div class="absolute inset-0 bg-slate-800 rounded-xl translate-y-1 translate-x-1 border border-white/5 z-0"></div>

                <div class="absolute -bottom-1.5 -right-1.5 bg-orange-500 text-white text-[9px] font-black w-5 h-5 rounded-full flex items-center justify-center border-2 border-slate-900 shadow-xl z-20">
                  {{ state.me.goalRemaining || 0 }}
                </div>
              }
            </div>
          </div>

          <div class="flex flex-col gap-2 shrink-0">
            <p class="text-slate-500 text-[8px] font-black uppercase tracking-widest text-center">Discards</p>

            <div class="flex gap-2.5">
              @for (slot of (state.me?.discards || [[], [], [], []]); let slotIdx=$index; track slotIdx ) {

                <div class="w-[58px] h-[128px]  relative flex-shrink-0">

                  <div cdkDropList
                       #dropList="cdkDropList"
                       [cdkDropListSortingDisabled]="true"
                       (cdkDropListDropped)="onDrop($event, slotIdx, 'discard')"
                       [class.ring-2]="selectedSource() === 'discard' && selectedIndex() === slotIdx"
                       class="absolute bottom-0 w-[58px] h-[86px] p-[1px] bg-slate-800/40  rounded-lg border border-white/5 ring-orange-400 cursor-pointer overflow-visible block common-pile-dropzone pointer-events-auto">

                    <div class="absolute inset-0 rounded-lg border-1  border-orange-500 opacity-0 transition-opacity duration-150 z-50 pointer-events-none drop-highlight"></div>

                    <div class="relative w-full h-full pointer-events-none">
                      @for (card of slot.slice(-3); track card.id; let i = $index; let total = $count) {

                        @if (i === total - 1) {
                          <div cdkDrag
                               [cdkDragData]="{ source: 'discard', cardId: card.id, sourceIndex: slotIdx }"
                               [cdkDragDisabled]="!canDragPredicate()"
                               class="absolute left-0 right-0 w-full pointer-events-auto"
                               [style.bottom.px]="(total - 1 - i) * 21"
                               [style.height.px]="84"
                               [style.z-index]="i">

                            <sb-card [card]="card"
                                     class="block w-full h-full shadow-lg rounded-lg border border-white/5"></sb-card>

                            <ng-template cdkDragPreview [matchSize]="true">
                              <div class="w-full h-full shadow-2xl rounded-lg">
                                <sb-card [card]="card" class="block w-full h-full rounded-lg"></sb-card>
                              </div>
                            </ng-template>

                            <div *cdkDragPlaceholder class="opacity-0"></div>
                          </div>
                        } @else {
                          <div class="absolute left-0 right-0 w-full"
                               [style.bottom.px]="(total - 1 - i) * 21"
                               [style.height.px]="84"
                               [style.z-index]="i">
                            <sb-card [card]="card" [class.brightness-50]="i < (total - 1)"
                                     class="block w-full h-full shadow-lg rounded-lg border border-white/5 pointer-events-none"></sb-card>
                          </div>
                        }
                      }
                    </div>

                    @if (slot.length === 0) {
                      <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span class="text-base font-black text-slate-500 opacity-20 select-none">D{{ slotIdx + 1 }}</span>

                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>

        <div class="flex justify-center items-end pt-4 pb-2 px-4 w-full relative min-h-[100px] hand-container">
          @if (state.me?.hand?.length) {
            <div cdkDropList
                 cdkDropListOrientation="horizontal"
                 [cdkDropListSortingDisabled]="true"
                 class="flex -space-x-3 overflow-visible my-hand"
                 [class.is-my-turn]="state.currentPlayerId === state.me.id">
              @for (card of state.me.hand; track card.id; let i = $index) {
                <div cdkDrag
                     [cdkDragData]="{ source: 'hand', cardId: card.id, sourceIndex: i }"
                     [cdkDragDisabled]="!canDragPredicate()"
                     (click)="selectFromHand(i, card.id)"
                     [class.is-selected]="selectedSource() === 'hand' && selectedIndex() === i"
                     class="hand-card shadow-xl pointer-events-auto">

                  <sb-card [card]="card"
                           class="block w-full h-full rounded-lg pointer-events-none animate-deal-card"
                           [style.animation-delay]="i * 50 + 'ms'">
                  </sb-card>

                  <ng-template cdkDragPreview [matchSize]="true">
                    <div class="w-full h-full flex items-center justify-center">
                      <div class="w-[3.5rem] h-[5.25rem] flex-shrink-0 shadow-2xl rounded-lg transform-none">
                        <sb-card [card]="card" class="block w-full h-full rounded-lg"></sb-card>
                      </div>
                    </div>
                  </ng-template>

                  <div *cdkDragPlaceholder class="w-[3.5rem] h-[5.25rem] flex-shrink-0 opacity-0"></div>
                </div>
              }
            </div>
          }
        </div>
      </section>
    </div>

    @if (!isGameReady()) {
      <div class="absolute inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex flex-col items-center justify-center p-8 text-center animate-in fade-in duration-500">
        <div class="bg-slate-800 p-8 rounded-[2.5rem] border border-white/10 shadow-2xl max-w-xs w-full animate-in zoom-in">
          <div class="relative w-16 h-16 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-orange-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
          </div>
          <h2 class="text-lg font-black mb-1 uppercase tracking-tighter text-white">Waiting Opponent</h2>
          <p class="text-slate-400 text-[10px] mb-6 font-medium uppercase tracking-widest">Code of the room</p>
          <div class="bg-slate-900 py-3 px-4 rounded-xl border border-white/5 flex items-center justify-between mb-2">
            <span class="font-mono text-orange-400 font-bold tracking-widest uppercase text-sm">{{ state.gameId }}</span>
            <button (click)="copyCode(state.gameId)" class="p-2 active:scale-90 transition-transform">
              @if (isCopied()) {
                <span class="text-[10px] font-bold text-green-500 animate-pulse uppercase">Copied!</span>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
              }
            </button>
          </div>
        </div>
      </div>
    }
  } @else {
    <div class="flex items-center justify-center h-screen bg-[#0f172a]">
      <div class="animate-pulse text-orange-500 font-black tracking-widest text-xs uppercase">Synchronization...</div>
    </div>
  }

  @if (showWinnerModal()) {
    <div class="fixed inset-0 z-[200] flex items-center justify-center bg-black/85 backdrop-blur-md px-4">
      <div class="animate-modal-entry bg-slate-900 border-2 border-yellow-500 p-10 rounded-3xl shadow-[0_0_50px_rgba(234,179,8,0.3)] text-center max-w-sm w-full relative overflow-hidden">
        <div class="absolute -top-24 -left-24 w-48 h-48 bg-yellow-500/10 blur-3xl rounded-full"></div>
        <div class="text-7xl mb-6 drop-shadow-lg">{{ winnerName() === '¬°YOU!' ? 'üèÜ' : 'ü§°' }}</div>
        <h2 class="text-5xl font-black text-white mb-2 tracking-tighter italic">{{ winnerName() === '¬°YOU!' ? 'VICTORY!' : 'GAME OVER' }}</h2>
        <p class="text-lg text-slate-400 mb-8 font-medium">The winner is <span class="text-yellow-400 font-bold underline decoration-2 underline-offset-4">{{ winnerName() }}</span></p>
        <div class="relative w-full bg-slate-800 rounded-full h-3 mb-4 overflow-hidden shadow-inner">
          <div class="bg-gradient-to-r from-yellow-600 via-yellow-400 to-yellow-600 h-full animate-progress-bar shadow-[0_0_10px_rgba(234,179,8,0.5)]"></div>
        </div>
        <div class="flex items-center justify-center gap-2 text-slate-500 text-xs font-bold uppercase tracking-widest">
          <span class="inline-block w-2 h-2 bg-slate-600 rounded-full animate-pulse"></span> Returning to lobby...
        </div>
      </div>
    </div>
  }
</div>
